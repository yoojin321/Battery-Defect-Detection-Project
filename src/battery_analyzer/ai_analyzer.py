"""
AI ë¶„ì„ ëª¨ë“ˆ
"""

import ollama
import streamlit as st
from .config import NORMAL_BATTERY_RULE, DEFECT_CLASSES
import time

class AIAnalyzer:
    """AI ë¶„ì„ í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.normal_rule = NORMAL_BATTERY_RULE
    
    def create_prompt(self, defect_info: str, analysis_type: str) -> str:
        """ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        if analysis_type == "defect_analysis":
            return f"""
ë‹¹ì‹ ì€ ë°°í„°ë¦¬ ê²°í•¨ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. (ì˜ë£Œ, ê±´ê°• ê´€ë ¨ ë¶„ì„ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

ì—…ë¡œë“œëœ 2ê°œì˜ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:
- ì²« ë²ˆì§¸ ì´ë¯¸ì§€: ë°°í„°ë¦¬ ì…€ì˜ CT ì´ë¯¸ì§€
- ë‘ ë²ˆì§¸ ì´ë¯¸ì§€: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ì—ì„œ ë°œê²¬ëœ ëª¨ë“  ê²°í•¨ ì˜ì—­ì„ ë§ˆìŠ¤í‚¹í•œ ì´ë¯¸ì§€
- {defect_info}

ì •ìƒ ë°°í„°ë¦¬ ì¡°ê±´: {self.normal_rule}

ì•„ë˜ í•­ëª©ì„ ì°¸ê³ í•˜ì—¬, ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ ê´€ì°°ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë…¼ë¦¬ì ì´ê³  êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

1. ë°°í„°ë¦¬ì˜ ì „ë°˜ì ì¸ êµ¬ì¡°ì™€ íŠ¹ì§•ì„ ê°„ë‹¨íˆ ìš”ì•½
2. íƒì§€ëœ ê²°í•¨(ë“¤)ì´ ì •ìƒ ì¡°ê±´ê³¼ ì–´ë–»ê²Œ ë‹¤ë¥¸ì§€, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì´ ê²°í•¨ìœ¼ë¡œ íŒë‹¨ë˜ëŠ”ì§€ ì„¤ëª…
3. ê° ê²°í•¨ì´ ë°°í„°ë¦¬ ì„±ëŠ¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥(ì‹¤ì œ ê´€ì°°ëœ ê²°í•¨ì˜ íŠ¹ì„±ì— ê·¼ê±°)
4. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­(ì¤‘ë³µ ì—†ì´ ê°„ê²°í•˜ê²Œ)

**ì£¼ì˜ì‚¬í•­**
- ê° í•­ëª©ì„ í•œ ë²ˆì”©ë§Œ, ì¤‘ë³µ ì—†ì´ ì„œìˆ 
- í”„ë¡¬í”„íŠ¸ ë¬¸êµ¬ë¥¼ ë³µì‚¬í•˜ì§€ ë§ê³ , ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ ê´€ì°°ëœ ì°¨ì´ì ê³¼ ê²°í•¨ì˜ ê·¼ê±°ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…
- ìì—°ìŠ¤ëŸ½ê³  ë…¼ë¦¬ì ì¸ í•œêµ­ì–´ë¡œ ì‘ì„±
"""
        else:
            return f"""
ë‹¹ì‹ ì€ ë°°í„°ë¦¬ ê²°í•¨ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. (ì˜ë£Œ, ê±´ê°• ê´€ë ¨ ë¶„ì„ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

ì—…ë¡œë“œëœ 2ê°œì˜ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:
- ì²« ë²ˆì§¸ ì´ë¯¸ì§€: ë°°í„°ë¦¬ ì…€ì˜ CT ì´ë¯¸ì§€
- ë‘ ë²ˆì§¸ ì´ë¯¸ì§€: ì²« ë²ˆì§¸ ì´ë¯¸ì§€ì—ì„œ ë°œê²¬ëœ ëª¨ë“  ê²°í•¨ ì˜ì—­ì„ ë§ˆìŠ¤í‚¹í•œ ì´ë¯¸ì§€
- {defect_info}

ì •ìƒ ë°°í„°ë¦¬ ì¡°ê±´: {self.normal_rule}

**ì¤‘ìš”: ê²°í•¨ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, ì •ìƒ ë°°í„°ë¦¬ë¡œ íŒë‹¨í•˜ì—¬ ë¶„ì„í•´ì£¼ì„¸ìš”.**

ì•„ë˜ í•­ëª©ì„ ì°¸ê³ í•˜ì—¬, ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ ê´€ì°°ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë…¼ë¦¬ì ì´ê³  êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

1. ë°°í„°ë¦¬ì˜ ì „ë°˜ì ì¸ êµ¬ì¡°ì™€ íŠ¹ì§•ì„ ê°„ë‹¨íˆ ìš”ì•½
2. ì •ìƒ ë°°í„°ë¦¬ì˜ íŠ¹ì§•ê³¼ ê´€ì°°ëœ êµ¬ì¡°ì˜ ì¼ì¹˜ì  ì„¤ëª…
3. ê²°í•¨ì´ ì—†ë‹¤ê³  íŒë‹¨í•œ ê·¼ê±° (ì •ìƒ ì¡°ê±´ê³¼ì˜ ë¹„êµ)
4. ê²°ë¡ 

**ì£¼ì˜ì‚¬í•­**
- ê²°í•¨ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, ê²°í•¨ ê´€ë ¨ ë‚´ìš©ì„ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”
- ì •ìƒ ë°°í„°ë¦¬ì˜ íŠ¹ì§•ê³¼ í˜„ì¬ ìƒíƒœì˜ ì¼ì¹˜ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…
- í”„ë¡¬í”„íŠ¸ ë¬¸êµ¬ë¥¼ ë³µì‚¬í•˜ì§€ ë§ê³ , ì‹¤ì œ ì´ë¯¸ì§€ì—ì„œ ê´€ì°°ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì„¤ëª…
- ìì—°ìŠ¤ëŸ½ê³  ë…¼ë¦¬ì ì¸ í•œêµ­ì–´ë¡œ ì‘ì„±
"""
    
    def analyze_image(self, image_path: str, mask_path: str, defect_info: str, analysis_type: str) -> str:
        """ì´ë¯¸ì§€ ë¶„ì„ ìˆ˜í–‰"""
        print("ğŸ”§ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...")
        prompt_start = time.time()
        prompt = self.create_prompt(defect_info, analysis_type)
        prompt_end = time.time()
        print(f"ğŸ“ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ: {prompt_end - prompt_start:.2f}ì´ˆ")
        print(f"ğŸ“„ í”„ë¡¬í”„íŠ¸ ê¸¸ì´: {len(prompt)} ë¬¸ì")
        
        print("ğŸ¤– LLaVA ëª¨ë¸ í˜¸ì¶œ ì¤‘...")
        try:
            llava_start = time.time()
            res = ollama.chat(
                model="llava:7b",
                messages=[
                    {
                        'role': 'user',
                        'content': prompt,
                        'images': [image_path, mask_path]
                    }
                ]
            )
            llava_end = time.time()
            llava_time = llava_end - llava_start
            print(f"âœ… LLaVA ì‘ë‹µ ì™„ë£Œ: {llava_time:.2f}ì´ˆ")
            
            result = res['message']['content']
            print(f"ğŸ“Š ì‘ë‹µ ê¸¸ì´: {len(result)} ë¬¸ì")
            return result
        except Exception as e:
            print(f"âŒ LLaVA ë¶„ì„ ì˜¤ë¥˜: {str(e)}")
            st.error(f"LLaVA ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
            return "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
    
    def answer_question(self, image_path: str, mask_path: str, question: str, analysis_result: str) -> str:
        """ì¶”ê°€ ì§ˆë¬¸ ë‹µë³€"""
        print("ğŸ”§ ì§ˆì˜ì‘ë‹µ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...")
        qa_prompt = f'''ë°°í„°ë¦¬ ê²°í•¨ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ë¶„ì„ ê²°ê³¼: {analysis_result}

ì§ˆë¬¸: {question}

ìœ„ ì •ë³´ì™€ ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ 3~4ë¬¸ì¥ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.'''
        
        print(f"ğŸ“„ ì§ˆì˜ì‘ë‹µ í”„ë¡¬í”„íŠ¸ ê¸¸ì´: {len(qa_prompt)} ë¬¸ì")
        print("ğŸ¤– LLaVA ì§ˆì˜ì‘ë‹µ í˜¸ì¶œ ì¤‘...")
        
        try:
            qa_llava_start = time.time()
            qa_res = ollama.chat(
                model="llava:7b",
                messages=[
                    {
                        'role': 'user',
                        'content': qa_prompt,
                        'images': [image_path, mask_path]
                    }
                ]
            )
            qa_llava_end = time.time()
            qa_llava_time = qa_llava_end - qa_llava_start
            print(f"âœ… LLaVA ì§ˆì˜ì‘ë‹µ ì™„ë£Œ: {qa_llava_time:.2f}ì´ˆ")
            
            result = qa_res['message']['content']
            print(f"ğŸ“Š ì§ˆì˜ì‘ë‹µ ê¸¸ì´: {len(result)} ë¬¸ì")
            return result
        except Exception as e:
            print(f"âŒ LLaVA ì§ˆì˜ì‘ë‹µ ì˜¤ë¥˜: {str(e)}")
            st.error(f"ì§ˆì˜ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
            return "ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." 